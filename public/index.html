<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4F46E5">
  <title>Card Price Checker</title>
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .camera-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="container mx-auto p-4 max-w-2xl">
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">üí≥ Card Price Checker</h1>
      <p class="text-gray-600 mb-6">Scan or upload a card to see raw sold prices</p>
      
      <!-- Image Input -->
      <div class="mb-6">
        <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
        <button onclick="triggerImageInput()" class="w-full camera-button text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition mb-3">
          üì∏ Take Photo / Upload Image
        </button>
        
        <div id="imagePreview" class="hidden mt-4">
          <img id="previewImg" class="w-full rounded-lg shadow-md">
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden text-center py-8">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600 mb-4"></div>
        <p class="text-gray-600 font-medium">Analyzing card...</p>
      </div>

      <!-- Card Info -->
      <div id="cardInfo" class="hidden bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl p-5 mb-6 border-2 border-indigo-200">
        <h2 class="text-xl font-bold text-gray-800 mb-3">üìã Card Identified</h2>
        <div id="cardDetails" class="space-y-2 text-gray-700"></div>
        <button onclick="searchEbay()" class="mt-4 w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition">
          üîç Search eBay Sold Prices
        </button>
      </div>

      <!-- Searching State -->
      <div id="searchingState" class="hidden text-center py-8">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-green-600 mb-4"></div>
        <p class="text-gray-600 font-medium">Searching eBay sold listings...</p>
      </div>

      <!-- Results -->
      <div id="results" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-800">üí∞ Sold Prices (Raw)</h2>
          <div class="bg-green-100 px-4 py-2 rounded-lg">
            <p class="text-xs text-gray-600">Average</p>
            <p id="avgPrice" class="text-xl font-bold text-green-700"></p>
          </div>
        </div>
        <div id="priceList" class="space-y-2"></div>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden bg-red-50 border-2 border-red-200 rounded-lg p-4">
        <p class="text-red-700 font-medium" id="errorMessage"></p>
      </div>
    </div>

    <p class="text-center text-gray-500 text-sm">Filters out all graded cards automatically</p>
  </div>

  <script>
    // IMPORTANT: Replace this with your actual backend URL after deployment
    const API_URL = 'http://localhost:3000';
    
    let currentCardInfo = null;

    function triggerImageInput() {
      document.getElementById('imageInput').click();
    }

    document.getElementById('imageInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('previewImg').src = e.target.result;
        document.getElementById('imagePreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);

      // Hide previous results
      document.getElementById('cardInfo').classList.add('hidden');
      document.getElementById('results').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('loadingState').classList.remove('hidden');

      // Send to backend for identification
      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch(`${API_URL}/api/identify-card`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        
        if (data.success) {
          currentCardInfo = data.cardInfo;
          displayCardInfo(data.cardInfo);
        } else {
          showError('Failed to identify card: ' + data.error);
        }
      } catch (error) {
        showError('Error connecting to server: ' + error.message);
      } finally {
        document.getElementById('loadingState').classList.add('hidden');
      }
    });

function displayCardInfo(info) {
  let details = `
    <p><strong>Player:</strong> <input type="text" id="edit-player" value="${info.player}" class="border rounded px-2 py-1 w-full mt-1"></p>
    <p><strong>Year:</strong> <input type="text" id="edit-year" value="${info.year}" class="border rounded px-2 py-1 w-32 mt-1"></p>
    <p><strong>Brand:</strong> <input type="text" id="edit-brand" value="${info.brand}" class="border rounded px-2 py-1 w-full mt-1"></p>
    <p><strong>Series:</strong> <input type="text" id="edit-series" value="${info.series}" class="border rounded px-2 py-1 w-full mt-1"></p>
    <p><strong>Card #:</strong> <input type="text" id="edit-cardNumber" value="${info.cardNumber}" class="border rounded px-2 py-1 w-32 mt-1"></p>
    <p><strong>Sport:</strong> <input type="text" id="edit-sport" value="${info.sport}" class="border rounded px-2 py-1 w-32 mt-1"></p>
  `;
  
  // Add autograph info if present
  if (info.autographed) {
    details += `<p><strong>‚úçÔ∏è Autographed:</strong> <span class="text-green-600 font-bold">YES</span></p>`;
  }
  
  // Add serial number if present (editable)
  if (info.serialNumber && info.serialNumber !== 'null') {
    details += `<p><strong>Serial #:</strong> <input type="text" id="edit-serialNumber" value="${info.serialNumber}" class="border rounded px-2 py-1 w-24 mt-1"></p>`;
  }
  
  // Add parallel if present (editable)
  if (info.parallel && info.parallel !== 'null') {
    details += `<p><strong>Parallel:</strong> <input type="text" id="edit-parallel" value="${info.parallel}" class="border rounded px-2 py-1 w-full mt-1 bg-yellow-50" placeholder="e.g., Gold Wave, Gold Shimmer"></p>`;
  }
  
  document.getElementById('cardDetails').innerHTML = details;
  document.getElementById('cardInfo').classList.remove('hidden');
}

async function searchEbay() {
  if (!currentCardInfo) return;

  // Get edited values from input fields
  const editedCardInfo = {
    player: document.getElementById('edit-player')?.value || currentCardInfo.player,
    year: document.getElementById('edit-year')?.value || currentCardInfo.year,
    brand: document.getElementById('edit-brand')?.value || currentCardInfo.brand,
    series: document.getElementById('edit-series')?.value || currentCardInfo.series,
    cardNumber: document.getElementById('edit-cardNumber')?.value || currentCardInfo.cardNumber,
    sport: document.getElementById('edit-sport')?.value || currentCardInfo.sport,
    autographed: currentCardInfo.autographed,
    serialNumber: document.getElementById('edit-serialNumber')?.value || currentCardInfo.serialNumber,
    parallel: document.getElementById('edit-parallel')?.value || currentCardInfo.parallel
  };

  document.getElementById('cardInfo').classList.add('hidden');
  document.getElementById('results').classList.add('hidden');
  document.getElementById('errorState').classList.add('hidden');
  document.getElementById('searchingState').classList.remove('hidden');

  try {
    const response = await fetch(`${API_URL}/api/search-ebay`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cardInfo: editedCardInfo })
    });

    const data = await response.json();

    if (data.success && data.soldPrices.length > 0) {
      displayResults(data.soldPrices);
    } else {
      showError('No raw/ungraded sold listings found for this card.');
    }
  } catch (error) {
    showError('Error searching eBay: ' + error.message);
  } finally {
    document.getElementById('searchingState').classList.add('hidden');
    document.getElementById('cardInfo').classList.remove('hidden');
  }
}

    function displayResults(prices) {
      const avgPrice = (prices.reduce((sum, p) => sum + p.price, 0) / prices.length).toFixed(2);
      document.getElementById('avgPrice').textContent = `$${avgPrice}`;

      const priceHTML = prices.map((p, idx) => `
        <div class="bg-white border-2 border-gray-200 rounded-lg p-3 flex justify-between items-center hover:shadow-md transition">
          <span class="text-gray-600 text-sm">${p.date}</span>
          <span class="text-2xl font-bold text-indigo-600">$${p.price.toFixed(2)}</span>
        </div>
      `).join('');

      document.getElementById('priceList').innerHTML = priceHTML;
      document.getElementById('results').classList.remove('hidden');
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorState').classList.remove('hidden');
    }

    // Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>