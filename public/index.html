<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sports Card Price Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
  </style>
</head>
<body class="p-4">
  <div class="max-w-2xl mx-auto">
    
    <!-- Header with Currency Toggle -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">üÉè Card Price Scanner</h1>
      
      <!-- Currency Toggle -->
      <div class="flex items-center justify-center gap-4 mb-2">
        <button id="usdBtn" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white transition">
          USD üá∫üá∏
        </button>
        <button id="cadBtn" class="px-6 py-2 rounded-lg font-semibold bg-gray-200 text-gray-700 transition">
          CAD üá®üá¶
        </button>
      </div>
      
      <div id="exchangeRate" class="text-center text-sm text-gray-600"></div>
    </div>

    <!-- Upload Section -->
    <div id="uploadSection" class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <label for="fileInput" class="block cursor-pointer">
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition">
          <div class="text-6xl mb-4">üì∏</div>
          <h3 class="text-xl font-semibold mb-2">Take or Upload Card Photo</h3>
          <p class="text-gray-600">Tap to take a photo or upload from gallery</p>
        </div>
      </label>
      <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden">
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
      <img id="previewImage" class="w-full rounded-lg mb-4 shadow-md" alt="Card preview">
      <button id="scanBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
        Identify Card
      </button>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden bg-white rounded-lg shadow-lg p-8 text-center">
      <div class="inline-block w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
      <p id="loadingText" class="text-gray-700">Analyzing card...</p>
    </div>

    <!-- Card Edit Form (NEW!) -->
    <div id="editSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Card Details - Review & Edit</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Player Name</label>
          <input type="text" id="editPlayer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Year (e.g., 2024-25)</label>
          <input type="text" id="editYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Brand</label>
          <input type="text" id="editBrand" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Series (e.g., Series 1, Chrome, Prizm)</label>
          <input type="text" id="editSeries" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Card Number</label>
          <input type="text" id="editCardNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Parallel/Variant</label>
          <input type="text" id="editParallel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Base">
        </div>
      </div>
      <button id="getPriceBtn" class="w-full mt-6 bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition">
        Get Price
      </button>
    </div>

    <!-- Error -->
    <div id="error" class="hidden bg-red-100 border-2 border-red-400 rounded-lg p-4 mb-6">
      <strong class="text-red-700">Error:</strong>
      <span id="errorMessage" class="text-red-600"></span>
    </div>

    <!-- Results -->
    <div id="results" class="hidden">
      
      <!-- Card Info -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Card Details</h3>
        <div class="space-y-2">
          <div class="flex justify-between py-2 border-b">
            <span class="font-semibold text-gray-600">Player:</span>
            <span id="player" class="text-gray-800"></span>
          </div>
          <div class="flex justify-between py-2 border-b">
            <span class="font-semibold text-gray-600">Year:</span>
            <span id="year" class="text-gray-800"></span>
          </div>
          <div class="flex justify-between py-2 border-b">
            <span class="font-semibold text-gray-600">Set:</span>
            <span id="set" class="text-gray-800"></span>
          </div>
          <div class="flex justify-between py-2 border-b">
            <span class="font-semibold text-gray-600">Card #:</span>
            <span id="cardNumber" class="text-gray-800"></span>
          </div>
          <div class="flex justify-between py-2">
            <span class="font-semibold text-gray-600">Sport:</span>
            <span id="sport" class="text-gray-800"></span>
          </div>
        </div>
      </div>

      <!-- Pricing -->
      <div class="bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg shadow-lg p-6 text-white mb-6">
        <h3 class="text-xl font-bold mb-4">Raw Card Price</h3>
        <div class="text-center mb-4">
          <div class="text-5xl font-bold" id="rawPrice">-</div>
          <div class="text-sm opacity-90 mt-2" id="priceSource">-</div>
        </div>
        <div class="text-center pt-4 border-t border-white border-opacity-30">
          <div class="text-sm opacity-90" id="salesVolume">-</div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="space-y-3">
        <button id="addToInventory" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition">
          Add to Inventory
        </button>
        <button id="scanAnother" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg hover:bg-gray-700 transition">
          Scan Another Card
        </button>
      </div>
    </div>

  </div>

  <script>
    // API Base URL
    const API_URL = 'https://card-price-checker.onrender.com';
    
    // Elements
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const scanBtn = document.getElementById('scanBtn');
    const editSection = document.getElementById('editSection');
    const getPriceBtn = document.getElementById('getPriceBtn');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    const results = document.getElementById('results');
    const scanAnother = document.getElementById('scanAnother');
    const addToInventory = document.getElementById('addToInventory');
    const usdBtn = document.getElementById('usdBtn');
    const cadBtn = document.getElementById('cadBtn');
    const exchangeRateDiv = document.getElementById('exchangeRate');

    // State
    let selectedFile = null;
    let currentCardInfo = null;
    let currentPricing = null;
    let currentCurrency = 'USD';
    let exchangeRate = 1.4;

    // Fetch exchange rate
    async function fetchExchangeRate() {
      try {
        const response = await fetch(`${API_URL}/api/exchange-rate`);
        const data = await response.json();
        if (data.success) {
          exchangeRate = data.rate;
          const rateText = data.source === 'live' ? 
            `Exchange rate: 1 USD ‚âà ${exchangeRate.toFixed(4)} CAD (live)` :
            `Exchange rate: 1 USD ‚âà ${exchangeRate.toFixed(4)} CAD (estimated)`;
          exchangeRateDiv.textContent = rateText;
        }
      } catch (err) {
        console.error('Failed to fetch exchange rate:', err);
        exchangeRateDiv.textContent = 'Exchange rate: 1 USD ‚âà 1.40 CAD (estimated)';
      }
    }

    // Initialize
    fetchExchangeRate();

    // Currency toggle
    usdBtn.addEventListener('click', () => {
      currentCurrency = 'USD';
      usdBtn.classList.add('bg-blue-600', 'text-white');
      usdBtn.classList.remove('bg-gray-200', 'text-gray-700');
      cadBtn.classList.add('bg-gray-200', 'text-gray-700');
      cadBtn.classList.remove('bg-blue-600', 'text-white');
      if (currentPricing) {
        updatePriceDisplay();
      }
    });

    cadBtn.addEventListener('click', () => {
      currentCurrency = 'CAD';
      cadBtn.classList.add('bg-blue-600', 'text-white');
      cadBtn.classList.remove('bg-gray-200', 'text-gray-700');
      usdBtn.classList.add('bg-gray-200', 'text-gray-700');
      usdBtn.classList.remove('bg-blue-600', 'text-white');
      if (currentPricing) {
        updatePriceDisplay();
      }
    });

    // File input change
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      selectedFile = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        uploadSection.classList.add('hidden');
        previewSection.classList.remove('hidden');
        editSection.classList.add('hidden');
        error.classList.add('hidden');
        results.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    });

    // Scan button - ONLY identifies card
    scanBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      // Show loading
      previewSection.classList.add('hidden');
      loading.classList.remove('hidden');
      loadingText.textContent = 'Analyzing card...';
      error.classList.add('hidden');
      editSection.classList.add('hidden');
      results.classList.add('hidden');

      try {
        // Convert image to base64
        const base64Image = await fileToBase64(selectedFile);
        
        // Remove data URL prefix to get just the base64 string
        const base64Data = base64Image.split(',')[1];

        console.log('Sending image to server...');

        // ONLY identify card
        const identifyResponse = await fetch(`${API_URL}/api/identify-card`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ image: base64Data })
        });

        if (!identifyResponse.ok) {
          throw new Error('Failed to identify card');
        }

        const identifyData = await identifyResponse.json();
        
        if (!identifyData.success) {
          throw new Error(identifyData.error || 'Failed to identify card');
        }

        currentCardInfo = identifyData.cardInfo;
        console.log('Card identified:', currentCardInfo);

        // Show edit form with identified data
        document.getElementById('editPlayer').value = currentCardInfo.player || '';
        document.getElementById('editYear').value = currentCardInfo.year || '';
        document.getElementById('editBrand').value = currentCardInfo.brand || '';
        document.getElementById('editSeries').value = currentCardInfo.series || '';
        document.getElementById('editCardNumber').value = currentCardInfo.cardNumber || '';
        document.getElementById('editParallel').value = currentCardInfo.parallel || 'Base';

        loading.classList.add('hidden');
        editSection.classList.remove('hidden');

      } catch (err) {
        console.error('Error:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        errorMessage.textContent = err.message;
        previewSection.classList.remove('hidden');
      }
    });

    // Get Price button - uses edited card info
    getPriceBtn.addEventListener('click', async () => {
      // Get edited values
      currentCardInfo = {
        player: document.getElementById('editPlayer').value,
        year: document.getElementById('editYear').value,
        brand: document.getElementById('editBrand').value,
        series: document.getElementById('editSeries').value,
        cardNumber: document.getElementById('editCardNumber').value,
        parallel: document.getElementById('editParallel').value || 'Base',
        sport: currentCardInfo.sport // Keep original sport
      };

      // Show loading
      editSection.classList.add('hidden');
      loading.classList.remove('hidden');
      loadingText.textContent = 'Getting price...';
      error.classList.add('hidden');

      try {
        const priceResponse = await fetch(`${API_URL}/api/get-price`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ cardInfo: currentCardInfo })
        });

        if (!priceResponse.ok) {
          throw new Error('Failed to get price');
        }

        const priceData = await priceResponse.json();
        
        if (!priceData.success || !priceData.pricing.found) {
          throw new Error(priceData.pricing?.message || 'Could not find pricing for this card from any source');
        }

        currentPricing = priceData.pricing;
        console.log('Price retrieved:', currentPricing);

        // Display results
        displayResults();

      } catch (err) {
        console.error('Error:', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        errorMessage.textContent = err.message;
        editSection.classList.remove('hidden');
      }
    });

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Display results
    function displayResults() {
      loading.classList.add('hidden');
      results.classList.remove('hidden');

      // Card details
      document.getElementById('player').textContent = currentCardInfo.player;
      document.getElementById('year').textContent = currentCardInfo.year;
      document.getElementById('set').textContent = `${currentCardInfo.brand} ${currentCardInfo.series}`;
      document.getElementById('cardNumber').textContent = currentCardInfo.cardNumber;
      document.getElementById('sport').textContent = currentCardInfo.sport;

      // Update price display
      updatePriceDisplay();
    }

    // Update price display based on currency
    function updatePriceDisplay() {
      const price = currentPricing.price;
      const currencySymbol = currentCurrency === 'USD' ? '$' : 'C$';
      const displayPrice = currentCurrency === 'USD' ? price : price * exchangeRate;

      document.getElementById('rawPrice').textContent = `${currencySymbol}${displayPrice.toFixed(2)}`;
      document.getElementById('priceSource').textContent = currentPricing.source || 'SportsCardsPro';
      document.getElementById('salesVolume').textContent = `${currentPricing.salesVolume} sales tracked`;
    }

    // Scan another
    scanAnother.addEventListener('click', () => {
      selectedFile = null;
      currentCardInfo = null;
      currentPricing = null;
      fileInput.value = '';
      previewSection.classList.add('hidden');
      editSection.classList.add('hidden');
      results.classList.add('hidden');
      error.classList.add('hidden');
      uploadSection.classList.remove('hidden');
    });

    // Add to inventory
    addToInventory.addEventListener('click', async () => {
      try {
        const currencySymbol = currentCurrency === 'USD' ? '$' : 'C$';
        const price = currentCurrency === 'USD' ? 
          currentPricing.price : 
          currentPricing.price * exchangeRate;

        const response = await fetch(
          'https://script.google.com/macros/s/AKfycbySXCDSo9YpGckzbvDWKXQN5l61VxAKvLMmFRv0g-VGb3WG7qpS-6Lb4JLO2ZDdgJMb/exec',
          {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              player: currentCardInfo.player,
              year: currentCardInfo.year,
              brand: currentCardInfo.brand,
              series: currentCardInfo.series,
              cardNumber: currentCardInfo.cardNumber,
              parallel: currentCardInfo.parallel || 'Base',
              price: `${currencySymbol}${price.toFixed(2)}`
            })
          }
        );

        alert('‚úÖ Card added to inventory!');
      } catch (err) {
        console.error('Error adding to inventory:', err);
        alert('‚ö†Ô∏è Added to inventory (confirmation unavailable due to CORS)');
      }
    });
  </script>
</body>
</html>
